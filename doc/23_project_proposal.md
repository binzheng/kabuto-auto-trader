# 📊 Kabuto Auto Trader - 自動株式取引システム企画案

（TradingView × Python自動売買基盤 × データ分析・バックテスト環境）

---

## 1. 表紙（Title）

**Kabuto Auto Trader プロジェクト**

* TradingView シグナル × Python自動売買基盤
* 対象市場：日本株
* 実行方式：楽天証券 MarketSpeed II（Excel VBA連携）
* 分析環境：Python バックテスト・パラメータ最適化

---

## 2. プロジェクト背景

### 背景・課題

* 株式取引における
  * 感情による判断ミス
  * ルールの不徹底
  * 再現性の低さ
* 手動取引では
  * 継続的な検証・改善が困難
  * ノウハウが属人化しやすい
  * データ駆動の意思決定ができない

---

## 3. 本プロジェクトの目的

### 目的

* **取引ルールを明確化・自動化**
* **感情を排除した取引の実現**
* **検証可能・再現可能な取引基盤の構築**
* **データ分析に基づく戦略最適化**

### ゴール

* 長期的に安定運用できる
  **「自社標準の自動売買基盤 + データ分析環境」** を構築する

---

## 4. 全体アーキテクチャ概要

### システム全体像

```text
┌─────────────────────────────────────────────────────────┐
│ TradingView (戦略実行)                                    │
│  - Pine Script戦略（kabuto_strategy_v1.pine）             │
│  - テクニカル指標計算（EMA, RSI, ATR等）                    │
│  - Webhook Alert送信                                     │
└─────────────────────────────────────────────────────────┘
                          ↓ JSON Webhook
┌─────────────────────────────────────────────────────────┐
│ Relay Server (Python/FastAPI) ⭐実装完了                   │
│  - シグナル検証・パラメータチェック                          │
│  - 6層防御機構（重複防止、時間外防止、リスク管理等）           │
│  - Kill Switch（連続損失、日次損失上限）                    │
│  - 包括的ログ記録（6種類、90日自動アーカイブ）                │
│  - Slack/Email通知（4レベル、頻度制限）                     │
└─────────────────────────────────────────────────────────┘
                          ↓ HTTP Polling
┌─────────────────────────────────────────────────────────┐
│ Excel VBA Client ⭐実装完了                                │
│  - 8モジュール、127関数、3,878行                           │
│  - ポーリング（30秒間隔）、約定確認                          │
│  - MarketSpeed II RSS連携（自動発注）                      │
│  - 安全装置（パラメータ検証、リスク管理、異常検知）            │
└─────────────────────────────────────────────────────────┘
                          ↓ RSS.ORDER()
┌─────────────────────────────────────────────────────────┐
│ MarketSpeed II (楽天証券)                                │
│  - 実際の注文執行                                         │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│ Analysis (データ分析・バックテスト) ⭐新規実装               │
│  - OHLCVデータ取得（Yahoo Finance）                       │
│  - 完全バックテスト（Look-ahead bias回避）                 │
│  - パラメータ最適化                                       │
│  - 戦略比較（Trend State vs Golden Cross）                │
│  - 詳細レポート（年利、月次分布、DD詳細）                    │
│  - Jupyter Notebooks（6個）                              │
└─────────────────────────────────────────────────────────┘
```

### ポイント

* TradingView は **シグナル発行のみ**
* 売買判断の最終責任は **Relay Server + Excel VBA**
* データ分析で **戦略を継続的に改善**

---

## 5. TradingView の役割

### TradingView とは

* 市場データに基づき
  **テクニカル指標を計算するツール**
* 将来予測は行わない

### 実装内容

* Pine Script戦略: `kabuto_strategy_v1.pine`
* テクニカル指標:
  - EMA（5, 25, 75期間）
  - RSI（14期間、50-70閾値）
  - 出来高フィルター（20期間平均×1.2倍）
  - ATR（14期間、SL 2倍、TP 4倍）
* Webhook Alert送信（JSON形式）

---

## 6. TradingView シグナルの考え方

### 誤解されやすい点

❌ TradingView が「売買判断をする」
⭕ あらかじめ定義した**ルールを実行するだけ**

### 重要な認識

> シグナル = 売買候補
> 実際に取引するかは **Relay Server + Excel VBA で判断**

---

## 7. Relay Server（Python/FastAPI）の役割

### システムの中核（最重要）⭐実装完了

**6層防御機構**:

1. パラメータ検証
2. リスク管理（ポジション・損失上限）
3. 二重注文防止
4. 時間外取引防止
5. 銘柄フィルター
6. 異常検知

**Kill Switch**:

- 5連続損失で自動停止
- 日次損失-5万円で自動停止
- 異常頻度検知（15分3件、1時間5件）

**ログ・通知**:

- 包括的ログ記録（6種類、90日自動アーカイブ）
- Slack/Email通知（4レベル、頻度制限）

👉 **安全性はすべてここで担保**

---

## 8. Excel VBA Client の役割

### 実装内容 ⭐実装完了

**8モジュール、127関数、3,878行**:

- `Module_Main.bas`: メインループ、ポーリング
- `Module_API.bas`: Relay Server通信
- `Module_RSS.bas`: MarketSpeed II RSS連携
- `Module_SignalProcessor.bas`: シグナル処理
- `Module_Config.bas`: 設定管理、安全装置
- `Module_OrderManager.bas`: 注文・ポジション管理
- `Module_Logger.bas`: ログ記録（18関数）
- `Module_Notification.bas`: Slack/Email通知（15関数）

**特徴**:

- 30秒ポーリング
- 約定状態監視
- SafeExecuteOrder（多段チェック）
- 異常検知・自動停止

---

## 9. 売買実行方式（楽天証券 MarketSpeed II）

### 実行方式

* MarketSpeed II RSS機能
* Excel VBA から `RSS.ORDER()` 関数で注文
* 約定確認・状態監視

### 採用理由

* 実績が多く安定している
* 手動介入が可能（安全）
* 全自動・半自動の切替が容易

---

## 10. リスク管理方針

### 基本ルール（実装済み）

* 1取引あたりの最大損失: ATR × 2.0倍（ストップロス）
* テイクプロフィット: ATR × 4.0倍
* 最低リスクリワード比: 1.5:1
* 1日の最大エントリー数: 3回
* クールダウン時間: 30分（損切り後60分）

### Kill Switch

* 5連続損失で自動停止
* 日次損失-5万円で自動停止
* 異常頻度検知

### 目的

* 一度の事故で資金を失わない
* 長期運用を前提とした設計

---

## 11. データ分析・バックテストの必要性 ⭐新規実装

### なぜバックテストが必要か

* 実運用前に
  **「このルールは過去どうだったか」** を検証するため
* 無計画な実運用は高リスク
* パラメータ最適化で戦略改善

---

## 12. データ分析・バックテスト環境

### 実装内容 ⭐新規実装

**実トレード分析**:

- ExecutionLog分析
- パフォーマンス指標計算（勝率、PF、シャープレシオ等）
- パラメータ最適化（Pine Script生成）

**完全バックテスト**:

- **Step A**: OHLCVデータ取得（Yahoo Finance、20年分）
- **Step B**: データクリーニング & 前処理
- **Step C**: テクニカルインジケーター計算
- **Step D**: エントリー/エグジットシグナル生成
- **Step E**: K線シミュレーション（Look-ahead bias回避）
- **Step F**: 詳細レポート（年利、月次分布、DD詳細）

**戦略比較**:

- Trend State戦略（EMA fast > medium > slow）
- Golden Cross戦略（Pine Script準拠、クロス検出）
- 100銘柄×2戦略 = 200バックテスト

---

## 13. バックテスト結果（2020-2024、5年間）

### 戦略比較結果


| 指標         | Trend State | Golden Cross | 優位         |
| ------------ | ----------- | ------------ | ------------ |
| 成功銘柄数   | 93          | 75           | Trend State  |
| 平均リターン | -1.91%      | **-0.56%**   | Golden Cross |
| 平均勝率     | 34.4%       | **42.7%**    | Golden Cross |
| 平均PF       | 1.09        | 1.02         | Trend State  |
| 平均取引数   | 11.8回      | 3.1回        | Trend State  |

### トップパフォーマー（Trend State）

1. **3681**: 12.68%リターン、勝率55.6%、PF 3.03
2. **5033**: 9.27%リターン、勝率66.7%、PF 3.70
3. **3563**: 8.44%リターン、勝率58.8%、PF 2.74

### 結論

* **Golden Cross戦略**が平均で優位（+1.35%改善）
* Pine Script（kabuto_strategy_v1.pine）をそのまま使用
* トップパフォーマー銘柄はTrend Stateが優位

---

## 14. 分析環境（Python × Mac）

### 分析ライブラリ（10ファイル、2,800+行）

**実トレード分析**:

- `data_loader.py`: Excel/DB読み込み
- `analytics.py`: パフォーマンス分析
- `optimizer.py`: パラメータ最適化

**バックテスト機能**:

- `market_data.py`: OHLCVデータ取得
- `data_cleaner.py`: データクリーニング
- `indicators.py`: テクニカルインジケーター
- `signal_generator.py`: シグナル生成（2戦略対応）
- `backtest_engine.py`: バックテストエンジン
- `backtest_analytics.py`: 詳細レポート

**Jupyter Notebooks（6個）**:

- 日次パフォーマンス分析
- 月次レポート
- 個別トレード分析
- バックテストシミュレーター
- パラメータ最適化
- 完全バックテスト（Step A〜F）

### 特徴

* 実運用と完全分離
* 低リスクで高速検証
* パラメータ最適化が容易
* Look-ahead bias回避
* 手数料・スリッページ考慮

---

## 15. 実装完了状況

### コード実装: 100%


| コンポーネント       | 状態    | 詳細                          |
| -------------------- | ------- | ----------------------------- |
| **Relay Server**     | ✅ 100% | FastAPI、全エンドポイント     |
| **Excel VBA**        | ✅ 100% | 8モジュール、127関数、3,878行 |
| **Analysis**         | ✅ 100% | 10ライブラリ、6 Notebooks     |
| **設計ドキュメント** | ✅ 100% | 22ファイル完成                |

### 手動作業: 🟡 73%

**Excelシート**: 🟡 手動作成（仕様書あり）

- Dashboard（仕様書あり）
- Config（仕様書あり）
- SignalLog（仕様書あり）
- NotificationHistory（仕様書あり）

**テストインフラ**: 🟡 計画のみ

- doc/21にテスト計画あり
- Pytest環境構築・テストケース実装が残作業

---

## 16. 開発ステップ（完了）

### フェーズ 1 ✅ 完了

* Relay Server実装
* Excel VBA Client実装
* 6層防御機構
* Kill Switch
* ログ・通知システム

### フェーズ 2 ✅ 完了

* データ分析環境構築
* 完全バックテスト機能
* 戦略比較分析
* パラメータ最適化

### フェーズ 3（次のステップ）

* Excelシート手動作成
* テストインフラ実装
* 実運用開始
* 継続的な戦略改善

---

## 17. 実運用と分析の役割分担


| 項目   | 技術                         | 目的             | 状態    |
| ------ | ---------------------------- | ---------------- | ------- |
| 実運用 | Python/FastAPI + Excel VBA   | 安定・安全な取引 | ✅ 完了 |
| 分析   | Python（pandas, yfinance等） | 戦略検証・改善   | ✅ 完了 |

👉 **研究コードを実運用に持ち込まない**

---

## 18. 期待される効果

* ✅ 取引ルールの明文化（Pine Script + 6層防御）
* ✅ 属人性の排除（全自動化）
* ✅ 継続的な改善が可能（バックテスト・最適化）
* ✅ 社内ノウハウの蓄積（22設計書、包括的ログ）
* ✅ データ駆動の意思決定（100銘柄バックテスト結果）

---

## 19. まとめ

### 本プロジェクトの価値

* **短期利益ではなく、長期安定運用を目指す**
* 技術 × リスク管理 × データ分析の組み合わせ
* 将来的な拡張・横展開が可能
* **実装完了率100%（コード）、73%（手動作業含む）**

---

## 20. 次のアクション

### 残作業

1. Excelシート手動作成（4枚、仕様書あり）
2. テストインフラ実装（doc/21に計画あり）

### 実運用開始

1. 小額・限定運用での検証（10-50万円）
2. バックテスト結果の良い銘柄で運用開始
3. 実トレード結果の継続分析
4. パラメータ最適化・戦略改善

### 横展開

1. 複数戦略対応
2. 他市場への適用
3. 社内ノウハウの共有・文書化

---

## 📌 技術資料

### 設計ドキュメント

- `doc/README.md` - 設計書索引
- `doc/01-17` - 基本設計、安全機構、取引フロー
- `doc/18` - 包括的ログ設計
- `doc/19` - 異常検知・通知設計
- `doc/20` - TradingView Backtest/Forward Test
- `doc/21` - サーバーテスト計画
- `doc/22` - 日次運用フロー

### 実装状況

- `IMPLEMENTATION_VERIFICATION.md` - 実装検証レポート

### 分析環境

- `analysis/README.md` - 分析環境完全ガイド
- `analysis/notebooks/06_full_backtest.ipynb` - 完全バックテスト

---

最終更新: 2025-12-28
