# 日本株自動売買システム 全体アーキテクチャ設計書

## 1. システム構成概要

```
┌─────────────────────────────────────────────────────────────┐
│                      TradingView Cloud                       │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Pine Script Strategy                                    │ │
│  │  - テクニカル指標計算                                   │ │
│  │  - エントリー/エグジット条件判定                         │ │
│  │  - Alert トリガー生成                                   │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │ Alert Webhook (HTTPS POST)             │
└─────────────────────┼──────────────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│              中継サーバー (macOS/Linux)                        │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Webhook Receiver (FastAPI/Flask)                        │ │
│  │  - HTTPS エンドポイント公開                              │ │
│  │  - 認証トークン検証                                      │ │
│  │  - JSON ペイロード解析                                   │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ リスク管理層 (風控)                                      │ │
│  │  - ポジションサイズ上限チェック                           │ │
│  │  - 1日あたり取引回数制限                                 │ │
│  │  - 損失額累計監視                                        │ │
│  │  - 市場時間チェック (9:00-15:00)                        │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ 重複排除層 (去重)                                        │ │
│  │  - シグナルID重複チェック (Redis/SQLite)                │ │
│  │  - 短時間同一銘柄注文防止 (5分以内)                      │ │
│  │  - べき等性保証                                          │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ ログ記録層 (日志)                                        │ │
│  │  - 全シグナル受信ログ (JSON)                             │ │
│  │  - リスク判定結果                                        │ │
│  │  - 注文指示送信ログ                                      │ │
│  │  - エラー/例外ログ                                       │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ 注文指示送信モジュール                                   │ │
│  │  - Windows VM 向け HTTP API 呼び出し                    │ │
│  │  - または共有フォルダ経由 JSON ファイル配置              │ │
│  └──────────────────┬─────────────────────────────────────┘ │
└─────────────────────┼──────────────────────────────────────┘
                      │ HTTP POST / File Drop
                      │
                      ▼
┌─────────────────────────────────────────────────────────────┐
│          Windows VM (Parallels/VMware Fusion)               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 注文受付サービス (Python/VBA)                            │ │
│  │  - HTTP Server (Flask) または File Watcher             │ │
│  │  - 注文パラメータ検証                                    │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ Excel VBA 制御層                                        │ │
│  │  - MarketSpeed II RSS 関数呼び出し                      │ │
│  │  - 注文関数実行 (rss.ORDER など)                         │ │
│  │  - 実行結果取得                                          │ │
│  └──────────────────┬─────────────────────────────────────┘ │
│                     │                                         │
│  ┌──────────────────▼─────────────────────────────────────┐ │
│  │ MarketSpeed II RSS                                      │ │
│  │  - リアルタイム株価取得                                  │ │
│  │  - 注文送信 (成行/指値/逆指値)                           │ │
│  │  - 約定通知受信                                          │ │
│  └──────────────────┬─────────────────────────────────────┘ │
└─────────────────────┼──────────────────────────────────────┘
                      │ 楽天証券 API
                      ▼
              ┌────────────────┐
              │  楽天証券システム  │
              │  (MarketSpeed)  │
              └────────────────┘
                      │
                      ▼
              ┌────────────────┐
              │   東京証券取引所   │
              └────────────────┘
```

---

## 2. データフロー詳細

### 2.1 正常系フロー

```
1. TradingView
   ├─ Pine Script が条件成立を検知
   ├─ Alert Webhook 発火
   └─ POST https://your-server.com/webhook
      Body: {
        "ticker": "9984",  // ソフトバンクG
        "action": "buy",
        "quantity": 100,
        "price": "market",
        "timestamp": "2025-12-27T09:05:00Z",
        "alert_id": "tv_abc123",
        "passphrase": "secret_token"
      }

2. 中継サーバー (Webhook Receiver)
   ├─ HTTPS 受信 (ポート 443)
   ├─ passphrase 認証
   ├─ JSON スキーマ検証
   └─ → リスク管理層へ

3. リスク管理層 (風控)
   ├─ 市場時間チェック: 9:00-15:00 以外なら拒否
   ├─ ポジションサイズ: 現在保有 + 新規 ≤ 上限
   ├─ 日次取引回数: 当日注文数 < 50回
   ├─ 損失上限: 当日実現損失 < -10万円なら停止
   └─ OK → 重複排除層へ / NG → ログして破棄

4. 重複排除層 (去重)
   ├─ Redis キー: f"signal:{alert_id}"
   ├─ 存在チェック → 存在すれば破棄
   ├─ 存在しなければ SET EX 300 (5分TTL)
   └─ → ログ記録層へ

5. ログ記録層 (日志)
   ├─ signals.log: 全受信シグナル記録
   ├─ orders.log: 承認された注文指示
   ├─ errors.log: リスク拒否・例外
   └─ → 注文指示送信へ

6. 注文指示送信
   【方式A: HTTP Push】
   └─ POST http://192.168.1.100:5000/order
      (Windows VM の IP)

   【方式B: File Drop】
   └─ 共有フォルダに order_<timestamp>.json 配置
      /Volumes/SharedVM/orders/

7. Windows VM (注文受付)
   【方式A】
   ├─ Flask サーバーが POST 受信
   └─ → Excel VBA 呼び出し

   【方式B】
   ├─ File Watcher (Python) がファイル検知
   ├─ JSON 読み込み
   └─ → Excel VBA 呼び出し

8. Excel VBA 制御層
   ├─ RSS.ORDER(銘柄コード, 売買区分, 数量, 価格)
   ├─ 実行結果を取得
   └─ → 結果を中継サーバーに返送 (HTTP POST)

9. MarketSpeed II RSS
   ├─ 楽天証券 API 経由で注文送信
   └─ 約定通知を RSS で取得

10. 約定結果の取得 (Pull)
    ├─ 中継サーバーが定期的に Windows VM をポーリング
    ├─ GET http://192.168.1.100:5000/executions
    └─ 約定データを DB に保存
```

### 2.2 異常系フロー

```
エラーパターン1: リスク制限超過
├─ 中継サーバーで注文を破棄
├─ errors.log に記録
└─ (オプション) Slack/Email 通知

エラーパターン2: Windows VM 応答なし
├─ 注文指示送信でタイムアウト (5秒)
├─ リトライ 3回 (指数バックオフ)
├─ 失敗したら alerts.log に記録
└─ 手動介入アラート送信

エラーパターン3: MarketSpeed II エラー
├─ Excel VBA がエラーコード取得
├─ HTTP レスポンスで中継サーバーに返送
├─ エラー内容に応じて再試行 or 破棄
└─ critical_errors.log に記録
```

---

## 3. 責務分離 (Separation of Concerns)

### 3.1 TradingView 層
| 責務 | 詳細 |
|------|------|
| **戦略ロジック** | Pine Script によるテクニカル指標計算・売買条件判定 |
| **シグナル生成** | Alert 発火タイミングの決定 |
| **NOT責務** | ポジション管理、リスク管理、注文実行、ログ保存 |

### 3.2 中継サーバー層
| 責務 | 詳細 |
|------|------|
| **認証・検証** | Webhook 認証トークン確認、JSON スキーマ検証 |
| **リスク管理** | ポジションサイズ・取引頻度・損失上限の制御 |
| **重複排除** | 同一シグナルの複数実行防止 (べき等性保証) |
| **ログ記録** | 全イベントの永続化 (監査証跡) |
| **注文ルーティング** | Windows VM への指示送信 |
| **約定管理** | 約定結果の取得・DB 保存 |
| **NOT責務** | 実際の注文実行、MarketSpeed II との直接通信 |

### 3.3 Windows VM 層
| 責務 | 詳細 |
|------|------|
| **注文受付** | HTTP Server / File Watcher による指示受信 |
| **RSS 制御** | Excel VBA による MarketSpeed II RSS 関数呼び出し |
| **注文実行** | 楽天証券システムへの注文送信 |
| **結果返送** | 注文受付結果・約定通知の中継サーバーへの返送 |
| **NOT責務** | リスク判定、戦略ロジック、長期ログ保存 |

### 3.4 MarketSpeed II RSS 層
| 責務 | 詳細 |
|------|------|
| **市場接続** | 楽天証券システムとの通信 |
| **株価取得** | リアルタイム株価・板情報の提供 |
| **注文送信** | 取引所への注文発注 |
| **約定通知** | 約定結果の Excel への通知 |
| **NOT責務** | 売買判断、リスク管理、ログ記録 |

---

## 4. Pull/Push 方針

### 4.1 Push型通信 (イベント駆動)

```
使用箇所: シグナル発生 → 注文実行

TradingView → 中継サーバー
  方式: Webhook (HTTPS POST)
  理由: リアルタイム性が最重要、遅延許容度 < 1秒

中継サーバー → Windows VM
  方式A (推奨): HTTP POST
    - 利点: 即時性、エラー応答の即時取得
    - 欠点: Windows VM が常時起動必要

  方式B (代替): 共有フォルダファイル配置
    - 利点: HTTP Server 不要、シンプル
    - 欠点: ポーリング遅延 (1-5秒)、ファイルロック問題
```

### 4.2 Pull型通信 (ポーリング)

```
使用箇所: 約定結果取得、ポジション確認

中継サーバー ← Windows VM (ポーリング)
  方式: 定期 HTTP GET (10秒ごと)
  エンドポイント:
    - GET /executions: 最新約定一覧
    - GET /positions: 現在ポジション
    - GET /balance: 余力情報

  理由:
    - 約定は注文後 数秒〜数分で発生
    - リアルタイム性の要求低い (10秒遅延許容)
    - Push型だと Windows VM → 中継サーバーの
      ネットワーク設定が複雑 (VM からの外部通信)

市場データ取得 (Optional)
  TradingView が提供するため基本不要
  ただし独自ロジック用に RSS から Pull 可能
```

### 4.3 ハイブリッド型

```
注文実行フロー (Push + Pull 組み合わせ)

1. [Push] TradingView → 中継サーバー
   シグナル発生時に即座に通知

2. [Push] 中継サーバー → Windows VM
   注文指示を即座に送信

3. [Push] Windows VM → 中継サーバー (同期応答)
   注文受付結果を HTTP レスポンスで即時返却
   {"status": "accepted", "order_id": "ORD123"}

4. [Pull] 中継サーバー → Windows VM (定期)
   10秒ごとにポーリングして約定確認
   GET /executions?order_id=ORD123

5. [Push] 約定発生時の高速通知 (Optional)
   Windows VM が約定検知時に Webhook 送信
   (ただし VM からの外部通信設定が必要)
```

---

## 5. 技術スタック推奨

### 5.1 中継サーバー
```python
# Webhook Receiver
- FastAPI (非同期処理、高速)
- または Flask (シンプル、学習容易)

# リスク管理・去重
- Redis (インメモリ DB、高速)
- SQLite (永続化、シンプル)

# ログ記録
- Python logging (標準ライブラリ)
- ログローテーション (logrotate)

# 約定管理 DB
- PostgreSQL (本格運用)
- または SQLite (個人利用)
```

### 5.2 Windows VM
```python
# 注文受付サービス
- Flask (HTTP Server)
- watchdog (File Watcher)

# Excel 制御
- VBA マクロ (RSS 関数呼び出し)
- または Python + pywin32 (COM 経由)

# プロセス管理
- NSSM (Windows サービス化)
```

---

## 6. 設定例

### 6.1 リスク管理パラメータ
```yaml
risk_control:
  max_position_size: 1000000  # 最大ポジション 100万円
  max_daily_trades: 50        # 1日最大50回
  max_daily_loss: -100000     # 1日最大損失 -10万円
  market_hours:
    start: "09:00"
    end: "15:00"
  blacklist_dates:            # 取引停止日
    - "2025-01-01"  # 元日
    - "2025-12-31"  # 大納会翌日
```

### 6.2 重複排除設定
```yaml
deduplication:
  cache_backend: "redis"
  ttl_seconds: 300           # 5分間キャッシュ
  same_ticker_interval: 60   # 同一銘柄は60秒空ける
```

---

*最終更新: 2025-12-27*
