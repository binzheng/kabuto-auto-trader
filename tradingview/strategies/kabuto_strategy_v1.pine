//@version=5
// ============================================================================
// Kabuto Trading Strategy v1.0
// æ—¥æœ¬æ ªè‡ªå‹•å£²è²·ã‚·ã‚¹ãƒ†ãƒ  - ä½é »åº¦ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ•ã‚©ãƒ­ãƒ¼æˆ¦ç•¥
// ============================================================================
strategy("Kabuto Strategy v1.0", "Kabuto", overlay=true, initial_capital=1000000, default_qty_type=strategy.percent_of_equity, default_qty_value=10, commission_type=strategy.commission.percent, commission_value=0.05, slippage=1, process_orders_on_close=false)

// ============================================================================
// å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
// ============================================================================

// --- ç§»å‹•å¹³å‡ç·šè¨­å®š ---
emaFastPeriod = input.int(5, "çŸ­æœŸEMAæœŸé–“", minval=1, group="ç§»å‹•å¹³å‡ç·š")
emaMediumPeriod = input.int(25, "ä¸­æœŸEMAæœŸé–“", minval=1, group="ç§»å‹•å¹³å‡ç·š")
emaSlowPeriod = input.int(75, "é•·æœŸEMAæœŸé–“", minval=1, group="ç§»å‹•å¹³å‡ç·š")

// --- RSIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---
rsiPeriod = input.int(14, "RSIæœŸé–“", minval=1, group="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™")
rsiLower = input.int(50, "RSIä¸‹é™", minval=0, maxval=100, group="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™")
rsiUpper = input.int(70, "RSIä¸Šé™", minval=0, maxval=100, group="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™")

// --- å‡ºæ¥é«˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---
volumePeriod = input.int(20, "å‡ºæ¥é«˜å¹³å‡æœŸé–“", minval=1, group="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™")
volumeMultiplier = input.float(1.2, "å‡ºæ¥é«˜å€ç‡", minval=1.0, step=0.1, group="ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™")

// --- ATRè¨­å®š ---
atrPeriod = input.int(14, "ATRæœŸé–“", minval=1, group="ATRè¨­å®š")
atrSlMultiplier = input.float(2.0, "ã‚¹ãƒˆãƒƒãƒ—ãƒ­ã‚¹å€ç‡", minval=0.5, step=0.1, group="ATRè¨­å®š")
atrTpMultiplier = input.float(4.0, "ãƒ†ã‚¤ã‚¯ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆå€ç‡", minval=1.0, step=0.1, group="ATRè¨­å®š")
minRrRatio = input.float(1.5, "æœ€ä½ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”", minval=1.0, step=0.1, group="ATRè¨­å®š")

// --- æœ€å°å€¤å¹…è¨­å®šï¼ˆæ‰‹æ•°æ–™å¯¾ç­–ï¼‰ ---
minProfitPercent = input.float(1.0, "æœ€å°åˆ©ç›Šç›®æ¨™ï¼ˆ%ï¼‰", minval=0.5, step=0.1, group="ATRè¨­å®š", tooltip="æ‰‹æ•°æ–™ã‚’è€ƒæ…®ã—ãŸæœ€å°åˆ©ç›Šå¹…ã€‚ATRãƒ™ãƒ¼ã‚¹ã‚ˆã‚Šå°ã•ã„å ´åˆã¯ã“ã®å€¤ã‚’ä½¿ç”¨")
minStopPercent = input.float(0.5, "æœ€å°ã‚¹ãƒˆãƒƒãƒ—ãƒ­ã‚¹ï¼ˆ%ï¼‰", minval=0.1, step=0.1, group="ATRè¨­å®š", tooltip="æœ€å°ã‚¹ãƒˆãƒƒãƒ—ãƒ­ã‚¹å¹…")

// --- ãƒªã‚¹ã‚¯ç®¡ç† ---
maxDailyEntries = input.int(3, "1æ—¥æœ€å¤§ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°", minval=1, maxval=10, group="ãƒªã‚¹ã‚¯ç®¡ç†")
cooldownMinutes = input.int(30, "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æ™‚é–“ï¼ˆåˆ†ï¼‰", minval=0, group="ãƒªã‚¹ã‚¯ç®¡ç†")
cooldownAfterLoss = input.int(60, "æåˆ‡ã‚Šå¾Œå¾…æ©Ÿæ™‚é–“ï¼ˆåˆ†ï¼‰", minval=0, group="ãƒªã‚¹ã‚¯ç®¡ç†")

// --- æ™‚é–“ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ ---
enableMorningSession = input.bool(true, "å‰å ´å–å¼•", group="æ™‚é–“å¸¯è¨­å®š")
morningStart = input.int(900, "å‰å ´é–‹å§‹ï¼ˆHHMMï¼‰", minval=0, maxval=2359, group="æ™‚é–“å¸¯è¨­å®š")
morningEnd = input.int(1130, "å‰å ´çµ‚äº†ï¼ˆHHMMï¼‰", minval=0, maxval=2359, group="æ™‚é–“å¸¯è¨­å®š")

enableAfternoonSession = input.bool(true, "å¾Œå ´å–å¼•", group="æ™‚é–“å¸¯è¨­å®š")
afternoonStart = input.int(1230, "å¾Œå ´é–‹å§‹ï¼ˆHHMMï¼‰", minval=0, maxval=2359, group="æ™‚é–“å¸¯è¨­å®š")
afternoonEnd = input.int(1530, "å¾Œå ´çµ‚äº†ï¼ˆHHMMï¼‰", minval=0, maxval=2359, group="æ™‚é–“å¸¯è¨­å®š")

forceCloseTime = input.int(1545, "å¼·åˆ¶æ±ºæ¸ˆæ™‚åˆ»ï¼ˆHHMMï¼‰", minval=0, maxval=2359, group="æ™‚é–“å¸¯è¨­å®š")

// --- Webhookè¨­å®š ---
webhookPassphrase = input.string("YOUR_SECRET_PASSPHRASE", "Webhook ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º", group="Webhookè¨­å®š")

// ============================================================================
// ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«æŒ‡æ¨™ã®è¨ˆç®—
// ============================================================================

// --- ç§»å‹•å¹³å‡ç·š ---
emaFast = ta.ema(close, emaFastPeriod)
emaMedium = ta.ema(close, emaMediumPeriod)
emaSlow = ta.ema(close, emaSlowPeriod)

// --- RSI ---
rsi = ta.rsi(close, rsiPeriod)

// --- å‡ºæ¥é«˜ ---
volumeAvg = ta.sma(volume, volumePeriod)

// --- ATR ---
atr = ta.atr(atrPeriod)

// ============================================================================
// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ¡ä»¶
// ============================================================================

// --- ãƒˆãƒ¬ãƒ³ãƒ‰ç¢ºèª ---
trendUp = emaMedium > emaSlow
trendStrength = (emaMedium - emaSlow) / emaSlow * 100  // ãƒˆãƒ¬ãƒ³ãƒ‰å¼·åº¦ï¼ˆ%ï¼‰

// --- ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ã‚¯ãƒ­ã‚¹ ---
goldenCross = ta.crossover(emaFast, emaMedium)

// --- RSIãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---
rsiFilter = rsi > rsiLower and rsi < rsiUpper

// --- å‡ºæ¥é«˜ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ ---
volumeFilter = volume > volumeAvg * volumeMultiplier

// ============================================================================
// æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰
// ============================================================================

// æ—¥æœ¬æ™‚é–“ã®å–å¾—
jstHour = hour(time, "Asia/Tokyo")
jstMinute = minute(time, "Asia/Tokyo")
jstTime = jstHour * 100 + jstMinute

// å‰å ´ã®å–å¼•å¯èƒ½æ™‚é–“
isMorningSession = enableMorningSession and jstTime >= morningStart and jstTime <= morningEnd

// å¾Œå ´ã®å–å¼•å¯èƒ½æ™‚é–“
isAfternoonSession = enableAfternoonSession and jstTime >= afternoonStart and jstTime <= afternoonEnd

// å–å¼•å¯èƒ½æ™‚é–“å¸¯
isSafeTime = isMorningSession or isAfternoonSession

// å¼·åˆ¶æ±ºæ¸ˆæ™‚åˆ»
isForceCloseTime = jstTime >= forceCloseTime

// ============================================================================
// æ—¥æ¬¡å–å¼•å›æ•°åˆ¶é™
// ============================================================================

var int dailyEntryCount = 0
var int lastEntryDay = 0
var bool enteredToday = false

// ç¾åœ¨ã®æ—¥ä»˜ï¼ˆJSTï¼‰
currentDay = dayofmonth(time, "Asia/Tokyo")

// æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‚‰ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
if currentDay != lastEntryDay
    dailyEntryCount := 0
    enteredToday := false
    lastEntryDay := currentDay

// æ—¥æ¬¡åˆ¶é™ãƒã‚§ãƒƒã‚¯
canEnterDaily = dailyEntryCount < maxDailyEntries and not enteredToday

// ============================================================================
// ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
// ============================================================================

var int lastEntryTime = 0
var int lastExitTime = 0
var bool lastExitWasLoss = false

// ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­ã‹ãƒã‚§ãƒƒã‚¯
isInCooldown() =>
    currentTime = time

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆä»»æ„éŠ˜æŸ„ï¼‰
    timeSinceEntry = (currentTime - lastEntryTime) / (1000 * 60)  // ãƒŸãƒªç§’â†’åˆ†
    globalCooldown = timeSinceEntry < cooldownMinutes

    // æåˆ‡ã‚Šå¾Œã®ãƒšãƒŠãƒ«ãƒ†ã‚£
    timeSinceExit = (currentTime - lastExitTime) / (1000 * 60)
    lossPenalty = lastExitWasLoss and timeSinceExit < cooldownAfterLoss

    globalCooldown or lossPenalty

// ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç†ç”±ã‚’å–å¾—
getCooldownReason() =>
    timeSinceEntry = (time - lastEntryTime) / (1000 * 60)
    timeSinceExit = (time - lastExitTime) / (1000 * 60)

    reason = ""
    if timeSinceEntry < cooldownMinutes
        reason := "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­: " + str.tostring(math.round(cooldownMinutes - timeSinceEntry, 1)) + "åˆ†"
    else if lastExitWasLoss and timeSinceExit < cooldownAfterLoss
        reason := "æåˆ‡ã‚ŠãƒšãƒŠãƒ«ãƒ†ã‚£: " + str.tostring(math.round(cooldownAfterLoss - timeSinceExit, 1)) + "åˆ†"
    reason

// ============================================================================
// ATRãƒ™ãƒ¼ã‚¹ SL/TP è¨ˆç®—
// ============================================================================

var float entryPrice = na
var float stopLossPrice = na
var float takeProfitPrice = na
var float actualRrRatio = na

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ã®ä¾¡æ ¼ãƒ»SL/TPè¨ˆç®—
if strategy.position_size == 0 and not na(entryPrice)
    entryPrice := na
    stopLossPrice := na
    takeProfitPrice := na
    actualRrRatio := na

// ============================================================================
// ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ­ã‚¸ãƒƒã‚¯
// ============================================================================

// å…¨æ¡ä»¶ã®ãƒã‚§ãƒƒã‚¯
allConditionsMet = trendUp and goldenCross and rsiFilter and volumeFilter
allRiskChecksPassed = canEnterDaily and not isInCooldown() and isSafeTime

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚·ã‚°ãƒŠãƒ«
longSignal = allConditionsMet and allRiskChecksPassed and strategy.position_size == 0

if longSignal
    // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼ã¨SL/TPã‚’è¨ˆç®—
    entryPrice := close

    // ATRãƒ™ãƒ¼ã‚¹ã®SL/TP
    atrBasedStopLoss = atr * atrSlMultiplier
    atrBasedTakeProfit = atr * atrTpMultiplier

    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ãƒ™ãƒ¼ã‚¹ã®æœ€å°å€¤å¹…
    minStopAmount = entryPrice * (minStopPercent / 100)
    minProfitAmount = entryPrice * (minProfitPercent / 100)

    // ATRãƒ™ãƒ¼ã‚¹ã¨æœ€å°å€¤å¹…ã®ã†ã¡å¤§ãã„æ–¹ã‚’ä½¿ç”¨
    stopLossAmount = math.max(atrBasedStopLoss, minStopAmount)
    takeProfitAmount = math.max(atrBasedTakeProfit, minProfitAmount)

    stopLossPrice := entryPrice - stopLossAmount
    takeProfitPrice := entryPrice + takeProfitAmount

    // ãƒªã‚¹ã‚¯ãƒªãƒ¯ãƒ¼ãƒ‰æ¯”ç‡ã®è¨ˆç®—
    riskAmount = entryPrice - stopLossPrice
    rewardAmount = takeProfitPrice - entryPrice
    actualRrRatio := rewardAmount / riskAmount

    // RRæ¯”ç‡ãŒåŸºæº–ã‚’æº€ãŸã™å ´åˆã®ã¿ã‚¨ãƒ³ãƒˆãƒªãƒ¼
    if actualRrRatio >= minRrRatio
        strategy.entry("Long", strategy.long)

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
        dailyEntryCount := dailyEntryCount + 1
        enteredToday := true
        lastEntryTime := time

        // ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒ­ã‚°ï¼ˆ100æ ªã§ã®åˆ©ç›Šè¦‹è¾¼ã¿ã‚‚è¡¨ç¤ºï¼‰
        expectedProfit = takeProfitAmount * 100
        expectedLoss = stopLossAmount * 100
        log.info("âœ… ã‚¨ãƒ³ãƒˆãƒªãƒ¼: " + str.tostring(entryPrice, "#.#") +
                 " | SL: " + str.tostring(stopLossPrice, "#.#") + " (-Â¥" + str.tostring(expectedLoss, "#,###") + ")" +
                 " | TP: " + str.tostring(takeProfitPrice, "#.#") + " (+Â¥" + str.tostring(expectedProfit, "#,###") + ")" +
                 " | RR: " + str.tostring(actualRrRatio, "#.#") + ":1")

// ============================================================================
// ã‚¨ã‚°ã‚¸ãƒƒãƒˆãƒ­ã‚¸ãƒƒã‚¯
// ============================================================================

if strategy.position_size > 0
    // SL/TPã«ã‚ˆã‚‹ã‚¨ã‚°ã‚¸ãƒƒãƒˆ
    strategy.exit("Exit", "Long",
                  stop=stopLossPrice,
                  limit=takeProfitPrice,
                  comment_loss="æåˆ‡ã‚Š",
                  comment_profit="åˆ©ç¢º")

    // å¼·åˆ¶æ±ºæ¸ˆï¼ˆå¤§å¼•ã‘å‰ï¼‰
    if isForceCloseTime
        strategy.close("Long", comment="å¼•ã‘å‰æ±ºæ¸ˆ")

// ã‚¨ã‚°ã‚¸ãƒƒãƒˆæ¤œçŸ¥ã¨ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ç®¡ç†
if strategy.position_size == 0 and strategy.position_size[1] > 0
    // å‰å›ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ãŒæå¤±ã ã£ãŸã‹
    if strategy.closedtrades > 0
        lastTradePnl = strategy.closedtrades.profit(strategy.closedtrades - 1)
        lastExitWasLoss := lastTradePnl < 0
        lastExitTime := time

        exitReason = lastExitWasLoss ? "æåˆ‡ã‚Š" : "åˆ©ç¢º"
        log.info("ğŸ”š ã‚¨ã‚°ã‚¸ãƒƒãƒˆ: " + exitReason + " | P&L: Â¥" + str.tostring(lastTradePnl, "#,###"))

// ============================================================================
// Alert Webhookï¼ˆJSONå½¢å¼ï¼‰
// ============================================================================

// ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆ
if longSignal and actualRrRatio >= minRrRatio
    alertMessage = '{"action": "buy","ticker": "' + syminfo.ticker + '","quantity": 100,"price": "market","entry_price": ' + str.tostring(entryPrice, "#.#") + ',"stop_loss": ' + str.tostring(stopLossPrice, "#.#") + ',"take_profit": ' + str.tostring(takeProfitPrice, "#.#") + ',"atr": ' + str.tostring(atr, "#.#") + ',"rr_ratio": ' + str.tostring(actualRrRatio, "#.#") + ',"rsi": ' + str.tostring(rsi, "#.#") + ',"timestamp": "' + str.tostring(time) + '","passphrase": "' + webhookPassphrase + '"}'
    alert(alertMessage, alert.freq_once_per_bar)

// ã‚¨ã‚°ã‚¸ãƒƒãƒˆã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆæåˆ‡ã‚Šï¼‰
// Note: ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒã‚¸ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
if not na(stopLossPrice) and close <= stopLossPrice
    alertMessage = '{"action": "sell","ticker": "' + syminfo.ticker + '","quantity": 100,"price": "market","exit_reason": "stop_loss","exit_price": ' + str.tostring(close, "#.#") + ',"timestamp": "' + str.tostring(time) + '","passphrase": "' + webhookPassphrase + '"}'
    alert(alertMessage, alert.freq_once_per_bar)

// ã‚¨ã‚°ã‚¸ãƒƒãƒˆã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆåˆ©ç¢ºï¼‰
// Note: ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒã‚¸ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
if not na(takeProfitPrice) and close >= takeProfitPrice
    alertMessage = '{"action": "sell","ticker": "' + syminfo.ticker + '","quantity": 100,"price": "market","exit_reason": "take_profit","exit_price": ' + str.tostring(close, "#.#") + ',"timestamp": "' + str.tostring(time) + '","passphrase": "' + webhookPassphrase + '"}'
    alert(alertMessage, alert.freq_once_per_bar)

// å¼·åˆ¶æ±ºæ¸ˆã‚¢ãƒ©ãƒ¼ãƒˆ
// Note: ãƒªãƒ¬ãƒ¼ã‚µãƒ¼ãƒãƒ¼å´ã§ãƒã‚¸ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
if isForceCloseTime
    alertMessage = '{"action": "sell","ticker": "' + syminfo.ticker + '","quantity": 100,"price": "market","exit_reason": "market_close","exit_price": ' + str.tostring(close, "#.#") + ',"timestamp": "' + str.tostring(time) + '","passphrase": "' + webhookPassphrase + '"}'
    alert(alertMessage, alert.freq_once_per_bar)

// ============================================================================
// ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
// ============================================================================

// --- ç§»å‹•å¹³å‡ç·š ---
plot(emaFast, "çŸ­æœŸEMA", color=color.new(color.orange, 0), linewidth=1)
plot(emaMedium, "ä¸­æœŸEMA", color=color.new(color.blue, 0), linewidth=2)
plot(emaSlow, "é•·æœŸEMA", color=color.new(color.purple, 0), linewidth=2)

// --- ã‚¨ãƒ³ãƒˆãƒªãƒ¼/SL/TP ---
plot(strategy.position_size > 0 ? entryPrice : na, "ã‚¨ãƒ³ãƒˆãƒªãƒ¼", color=color.new(color.blue, 0), linewidth=2, style=plot.style_linebr)
plot(strategy.position_size > 0 ? stopLossPrice : na, "ã‚¹ãƒˆãƒƒãƒ—ãƒ­ã‚¹", color=color.new(color.red, 0), linewidth=2, style=plot.style_linebr)
plot(strategy.position_size > 0 ? takeProfitPrice : na, "ãƒ†ã‚¤ã‚¯ãƒ—ãƒ­ãƒ•ã‚£ãƒƒãƒˆ", color=color.new(color.green, 0), linewidth=2, style=plot.style_linebr)

// --- å–å¼•å¯èƒ½æ™‚é–“å¸¯ã®èƒŒæ™¯è‰² ---
bgcolor(isSafeTime ? color.new(color.green, 95) : color.new(color.red, 98), title="å–å¼•å¯èƒ½æ™‚é–“å¸¯")

// --- ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã‚·ã‚°ãƒŠãƒ«ã®ãƒãƒ¼ã‚¯ ---
plotshape(longSignal and actualRrRatio >= minRrRatio, "è²·ã„ã‚·ã‚°ãƒŠãƒ«", style=shape.triangleup, location=location.belowbar, color=color.new(color.green, 0), size=size.small)

// ============================================================================
// æƒ…å ±ãƒ‘ãƒãƒ«
// ============================================================================

var table infoPanel = table.new(position.top_right, 2, 12, border_width=1, border_color=color.gray, frame_width=1, frame_color=color.gray)

if barstate.islast
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    table.cell(infoPanel, 0, 0, "Kabuto Strategy", bgcolor=color.new(color.blue, 30), text_color=color.white, text_size=size.normal)
    table.cell(infoPanel, 1, 0, "v1.0", bgcolor=color.new(color.blue, 30), text_color=color.white)

    // æ—¥æ¬¡ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ•°
    table.cell(infoPanel, 0, 1, "æœ¬æ—¥ã‚¨ãƒ³ãƒˆãƒªãƒ¼", text_color=color.white)
    entryColor = dailyEntryCount >= maxDailyEntries ? color.new(color.red, 30) : color.new(color.green, 30)
    table.cell(infoPanel, 1, 1, str.tostring(dailyEntryCount) + "/" + str.tostring(maxDailyEntries), bgcolor=entryColor, text_color=color.white)

    // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³çŠ¶æ…‹
    table.cell(infoPanel, 0, 2, "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³", text_color=color.white)
    cooldownStatus = isInCooldown() ? "â¸ï¸" : "âœ…"
    cooldownColor = isInCooldown() ? color.new(color.red, 30) : color.new(color.green, 30)
    table.cell(infoPanel, 1, 2, cooldownStatus, bgcolor=cooldownColor, text_color=color.white)

    // æ™‚é–“å¸¯
    table.cell(infoPanel, 0, 3, "æ™‚åˆ»ï¼ˆJSTï¼‰", text_color=color.white)
    table.cell(infoPanel, 1, 3, str.tostring(jstHour, "#00") + ":" + str.tostring(jstMinute, "#00"), text_color=color.white)

    // å–å¼•å¯èƒ½æ™‚é–“
    table.cell(infoPanel, 0, 4, "å–å¼•æ™‚é–“", text_color=color.white)
    timeStatus = isSafeTime ? "âœ…" : "â¸ï¸"
    timeColor = isSafeTime ? color.new(color.green, 30) : color.new(color.red, 30)
    table.cell(infoPanel, 1, 4, timeStatus, bgcolor=timeColor, text_color=color.white)

    // ATR
    table.cell(infoPanel, 0, 5, "ATR(14)", text_color=color.white)
    table.cell(infoPanel, 1, 5, str.tostring(atr, "#.#") + " (Â¥" + str.tostring(atr * 100, "#,###") + "/100æ ª)", text_color=color.white)

    // æœ€å°åˆ©ç›Šç›®æ¨™
    table.cell(infoPanel, 0, 6, "æœ€å°åˆ©ç›Šç›®æ¨™", text_color=color.white)
    minProfitYen = close * (minProfitPercent / 100) * 100
    table.cell(infoPanel, 1, 6, str.tostring(minProfitPercent, "#.#") + "% (Â¥" + str.tostring(minProfitYen, "#,###") + "/100æ ª)", text_color=color.white)

    // RSI
    table.cell(infoPanel, 0, 7, "RSI(14)", text_color=color.white)
    rsiColor = rsi > rsiUpper ? color.new(color.red, 30) : rsi < rsiLower ? color.new(color.orange, 30) : color.new(color.green, 30)
    table.cell(infoPanel, 1, 7, str.tostring(rsi, "#.#"), bgcolor=rsiColor, text_color=color.white)

    // å‡ºæ¥é«˜å€ç‡
    table.cell(infoPanel, 0, 8, "å‡ºæ¥é«˜å€ç‡", text_color=color.white)
    volRatio = volume / volumeAvg
    volColor = volRatio >= volumeMultiplier ? color.new(color.green, 30) : color.new(color.gray, 30)
    table.cell(infoPanel, 1, 8, str.tostring(volRatio, "#.#") + "x", bgcolor=volColor, text_color=color.white)

    // ãƒã‚¸ã‚·ãƒ§ãƒ³çŠ¶æ…‹
    table.cell(infoPanel, 0, 9, "ãƒã‚¸ã‚·ãƒ§ãƒ³", text_color=color.white)
    posStatus = strategy.position_size > 0 ? "ä¿æœ‰ä¸­" : "ãªã—"
    posColor = strategy.position_size > 0 ? color.new(color.blue, 30) : color.new(color.gray, 30)
    table.cell(infoPanel, 1, 9, posStatus, bgcolor=posColor, text_color=color.white)

    // æœŸå¾…åˆ©ç›Šï¼ˆæ¬¡å›ã‚¨ãƒ³ãƒˆãƒªãƒ¼æ™‚ï¼‰
    table.cell(infoPanel, 0, 10, "æœŸå¾…åˆ©ç›Šï¼ˆäºˆæ¸¬ï¼‰", text_color=color.white)
    expectedTpAmount = math.max(atr * atrTpMultiplier, close * (minProfitPercent / 100))
    expectedTpYen = expectedTpAmount * 100
    table.cell(infoPanel, 1, 10, "Â¥" + str.tostring(expectedTpYen, "#,###") + "/100æ ª", text_color=color.white)

    // ç·åˆåˆ¤å®š
    table.cell(infoPanel, 0, 11, "å–å¼•å¯å¦", text_color=color.white)
    canTrade = allRiskChecksPassed and strategy.position_size == 0
    tradeStatus = canTrade ? "âœ…" : "â¸ï¸"
    tradeColor = canTrade ? color.new(color.green, 30) : color.new(color.red, 30)
    table.cell(infoPanel, 1, 11, tradeStatus, bgcolor=tradeColor, text_color=color.white)

// ============================================================================
// ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³è¡¨ç¤ºï¼ˆãƒãƒ£ãƒ¼ãƒˆä¸Šï¼‰
// ============================================================================

var label cooldownLabel = na
if barstate.islast and isInCooldown()
    reason = getCooldownReason()
    if na(cooldownLabel)
        cooldownLabel := label.new(bar_index, high * 1.01, reason, style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.normal)
    else
        label.set_xy(cooldownLabel, bar_index, high * 1.01)
        label.set_text(cooldownLabel, reason)
else if not na(cooldownLabel)
    label.delete(cooldownLabel)
    cooldownLabel := na

// ============================================================================
// ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆï¼ˆãƒ­ã‚°å‡ºåŠ›ï¼‰
// ============================================================================

if barstate.islastconfirmedhistory
    totalTrades = strategy.closedtrades
    winningTrades = strategy.wintrades
    losingTrades = strategy.losstrades
    winRate = totalTrades > 0 ? winningTrades / totalTrades * 100 : 0

    log.info("=== ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆçµæœ ===")
    log.info("ç·å–å¼•æ•°: " + str.tostring(totalTrades))
    log.info("å‹ã¡ãƒˆãƒ¬ãƒ¼ãƒ‰: " + str.tostring(winningTrades))
    log.info("è² ã‘ãƒˆãƒ¬ãƒ¼ãƒ‰: " + str.tostring(losingTrades))
    log.info("å‹ç‡: " + str.tostring(winRate, "#.#") + "%")
    log.info("ç´”åˆ©ç›Š: Â¥" + str.tostring(strategy.netprofit, "#,###"))
    log.info("æœ€å¤§ãƒ‰ãƒ­ãƒ¼ãƒ€ã‚¦ãƒ³: Â¥" + str.tostring(strategy.max_drawdown, "#,###"))

// ============================================================================
// End of Strategy
// ============================================================================
