//@version=5
// ============================================================================
// Webhook ç–é€šãƒ†ã‚¹ãƒˆç”¨ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼
// TradingView â†’ Relay Server ã®æ¥ç¶šç¢ºèªç”¨
// ============================================================================
strategy("Webhook Test", "WebhookTest", overlay=true, initial_capital=1000000)

// ============================================================================
// è¨­å®š
// ============================================================================

// ãƒ†ã‚¹ãƒˆéŠ˜æŸ„
testTicker = input.string("9984", "ãƒ†ã‚¹ãƒˆéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰", group="ãƒ†ã‚¹ãƒˆè¨­å®š")

// Webhook ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºï¼ˆrelay_server/config.yaml ã® security.webhook_secret ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
webhookPassphrase = input.string("JhZd2DaPMxzL69zq_yOllQaMfaOfu-vSPtvtHnQSweY", "Webhook ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚º", group="ãƒ†ã‚¹ãƒˆè¨­å®š")

// ============================================================================
// ãƒ†ã‚¹ãƒˆãƒ­ã‚¸ãƒƒã‚¯
// ============================================================================

// å‰å›é€ä¿¡æ™‚åˆ»ï¼ˆãƒŸãƒªç§’ï¼‰
var int lastSendTime = 0

// é€ä¿¡å›æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
var int sendCount = 0

// é€ä¿¡é–“éš”ï¼ˆãƒŸãƒªç§’ï¼‰ - 1åˆ† = 60000ms
sendIntervalMs = 60000

// ã‚¢ãƒ©ãƒ¼ãƒˆç”¨å¤‰æ•°ï¼ˆTradingViewã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä½¿ç”¨ï¼‰
var float testEntryPrice = na
var float testStopLoss = na
var float testTakeProfit = na
var float testAtr = na
var float testRrRatio = na
var float testRsi = na

// å‰å›é€ä¿¡ã‹ã‚‰ã®çµŒéæ™‚é–“
timeSinceLastSend = time - lastSendTime

// 1åˆ†ã”ã¨ã«ãƒ†ã‚¹ãƒˆã‚·ã‚°ãƒŠãƒ«ã‚’ç”Ÿæˆï¼ˆåˆå›ã¯å³åº§ã«é€ä¿¡ï¼‰
testSignal = barstate.isrealtime and barstate.islast and (lastSendTime == 0 or timeSinceLastSend >= sendIntervalMs)

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ï¼ˆæ¯ãƒãƒ¼ï¼‰
if barstate.islast
    log.info("ğŸ“Š Debug: isRealtime=" + str.tostring(barstate.isrealtime) + " | islast=" + str.tostring(barstate.islast) + " | lastSend=" + str.tostring(lastSendTime) + " | elapsed=" + str.tostring(timeSinceLastSend / 1000) + "s | signal=" + str.tostring(testSignal))

if testSignal
    // ãƒ†ã‚¹ãƒˆæ³¨æ–‡ã‚’å®Ÿè¡Œ
    strategy.entry("TestBuy", strategy.long, qty=100)

    // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¾¡æ ¼ã¨SL/TPï¼ˆãƒ€ãƒŸãƒ¼å€¤ï¼‰ã‚’è¨ˆç®—
    testEntryPrice := close
    testStopLoss := close * 0.95  // -5%
    testTakeProfit := close * 1.10  // +10%
    testAtr := close * 0.02  // 2%
    testRrRatio := (testTakeProfit - testEntryPrice) / (testEntryPrice - testStopLoss)
    testRsi := 60.0

    // å¤‰æ•°ã‚’å…¬é–‹ï¼ˆTradingViewã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä½¿ç”¨å¯èƒ½ï¼‰
    // alertMessageå¤‰æ•°ã¯ä¸è¦ã«ãªã‚Šã¾ã—ãŸï¼ˆTradingViewã®ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã§ç›´æ¥JSONã‚’è¨˜è¿°ï¼‰

    // é€ä¿¡æ™‚åˆ»ã‚’è¨˜éŒ²
    lastSendTime := time
    sendCount := sendCount + 1

    // è©³ç´°ãƒ­ã‚°å‡ºåŠ›
    log.info("============================================================")
    log.info("ğŸ”” Webhooké€ä¿¡ #" + str.tostring(sendCount))
    log.info("ğŸ“ éŠ˜æŸ„: " + testTicker + " @ Â¥" + str.tostring(testEntryPrice, "#.##"))
    log.info("â° é€ä¿¡æ™‚åˆ»: " + str.tostring(year) + "-" + str.tostring(month, "#00") + "-" + str.tostring(dayofmonth, "#00") + " " + str.tostring(hour, "#00") + ":" + str.tostring(minute, "#00") + ":" + str.tostring(second, "#00"))
    log.info("ğŸ“Š ãƒ‡ãƒ¼ã‚¿: SL=" + str.tostring(testStopLoss, "#.##") + " | TP=" + str.tostring(testTakeProfit, "#.##") + " | RR=" + str.tostring(testRrRatio, "#.##"))
    log.info("============================================================")
    log.info("âš ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯TradingViewã®ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã§è¨­å®šã—ã¦ãã ã•ã„")
    log.info("   ã‚¢ãƒ©ãƒ¼ãƒˆãƒ‘ãƒãƒ« â†’ ã‚¢ãƒ©ãƒ¼ãƒˆç·¨é›† â†’ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸")

// ãƒ†ã‚¹ãƒˆãƒã‚¸ã‚·ãƒ§ãƒ³ã‚’å³åº§ã«æ±ºæ¸ˆï¼ˆãƒãƒ£ãƒ¼ãƒˆã‚’æ±šã•ãªã„ãŸã‚ï¼‰
// alert_messageã‚’æŒ‡å®šã—ãªã„ã“ã¨ã§ã€Webhookã‚¢ãƒ©ãƒ¼ãƒˆã‚’é€ä¿¡ã—ãªã„
if strategy.position_size > 0
    strategy.close("TestBuy", comment="ãƒ†ã‚¹ãƒˆçµ‚äº†", alert_message="")

// ============================================================================
// ãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º
// ============================================================================

// ãƒ†ã‚¹ãƒˆã‚·ã‚°ãƒŠãƒ«ç™ºç”Ÿæ™‚ã®èƒŒæ™¯è‰²
bgcolor(testSignal ? color.new(color.green, 90) : na, title="ãƒ†ã‚¹ãƒˆé€ä¿¡ä¸­")

// ãƒ†ã‚¹ãƒˆã‚·ã‚°ãƒŠãƒ«ã®ãƒãƒ¼ã‚¯
plotshape(testSignal, "ãƒ†ã‚¹ãƒˆã‚·ã‚°ãƒŠãƒ«", style=shape.triangleup, location=location.belowbar, color=color.new(color.blue, 0), size=size.large)

// æƒ…å ±ãƒ‘ãƒãƒ«
var table infoPanel = table.new(position.top_right, 2, 8, border_width=1, border_color=color.gray, frame_width=1, frame_color=color.gray)

if barstate.islast
    table.cell(infoPanel, 0, 0, "Webhook Test", bgcolor=color.new(color.blue, 30), text_color=color.white, text_size=size.normal)
    table.cell(infoPanel, 1, 0, "v1.0", bgcolor=color.new(color.blue, 30), text_color=color.white)

    table.cell(infoPanel, 0, 1, "éŠ˜æŸ„", text_color=color.white)
    table.cell(infoPanel, 1, 1, testTicker, text_color=color.white)

    table.cell(infoPanel, 0, 2, "ãƒ†ã‚¹ãƒˆçŠ¶æ…‹", text_color=color.white)
    timeUntilNext = lastSendTime > 0 ? math.max(0, sendIntervalMs - timeSinceLastSend) / 1000 : 0
    testStatus = lastSendTime > 0 ? "æ¬¡å›: " + str.tostring(math.round(timeUntilNext)) + "ç§’å¾Œ" : "â³ å¾…æ©Ÿä¸­"
    testColor = lastSendTime > 0 ? color.new(color.green, 30) : color.new(color.orange, 30)
    table.cell(infoPanel, 1, 2, testStatus, bgcolor=testColor, text_color=color.white)

    table.cell(infoPanel, 0, 3, "é€ä¿¡å›æ•°", text_color=color.white)
    table.cell(infoPanel, 1, 3, str.tostring(sendCount) + " å›", text_color=color.white)

    table.cell(infoPanel, 0, 4, "ç¾åœ¨ä¾¡æ ¼", text_color=color.white)
    table.cell(infoPanel, 1, 4, str.tostring(close, "#.##"), text_color=color.white)

    table.cell(infoPanel, 0, 5, "Passphrase", text_color=color.white)
    passphraseDisplay = str.length(webhookPassphrase) > 8 ? str.substring(webhookPassphrase, 0, 8) + "..." : webhookPassphrase
    table.cell(infoPanel, 1, 5, passphraseDisplay, text_color=color.new(color.yellow, 0))

    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
    table.cell(infoPanel, 0, 6, "ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ", text_color=color.white)
    realtimeStatus = barstate.isrealtime ? "âœ… YES" : "â³ NO (å¾…æ©Ÿä¸­)"
    realtimeColor = barstate.isrealtime ? color.new(color.green, 30) : color.new(color.red, 30)
    table.cell(infoPanel, 1, 6, realtimeStatus, bgcolor=realtimeColor, text_color=color.white)

    table.cell(infoPanel, 0, 7, "çµŒéæ™‚é–“", text_color=color.white)
    elapsedSeconds = timeSinceLastSend / 1000
    table.cell(infoPanel, 1, 7, str.tostring(math.round(elapsedSeconds)) + "ç§’", text_color=color.white)

// ============================================================================
// ä½¿ã„æ–¹
// ============================================================================
// 1. TradingViewã§ã“ã®ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã‚’ãƒãƒ£ãƒ¼ãƒˆã«è¿½åŠ 
// 2. è¨­å®šã§ã€ŒWebhook ãƒ‘ã‚¹ãƒ•ãƒ¬ãƒ¼ã‚ºã€ã‚’relay_serverã®config.yamlã¨ä¸€è‡´ã•ã›ã‚‹
// 3. ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ä½œæˆ:
//    - æ¡ä»¶: "Webhook Test"
//    - ã‚ªãƒ—ã‚·ãƒ§ãƒ³: "æ³¨æ–‡ç´„å®šæ™‚"
//    - Webhook URL: https://YOUR-RELAY-SERVER/webhook/test
//    - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: {{strategy.order.alert_message}}
// 4. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ¼ã§è‡ªå‹•çš„ã«WebhookãŒ1åˆ†ã”ã¨ã«é€ä¿¡ã•ã‚Œã¾ã™
// 5. relay_serverã®ãƒ­ã‚°ã§å—ä¿¡ã‚’ç¢ºèª
// 6. æƒ…å ±ãƒ‘ãƒãƒ«ã§é€ä¿¡çŠ¶æ…‹ã‚’ç¢ºèª:
//    - ãƒ†ã‚¹ãƒˆçŠ¶æ…‹: æ¬¡å›é€ä¿¡ã¾ã§ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³
//    - é€ä¿¡å›æ•°: ç´¯ç©é€ä¿¡å›æ•°
// 7. ãƒ†ã‚¹ãƒˆã‚’åœæ­¢ã™ã‚‹å ´åˆã¯ã€ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼ã‚’å‰Šé™¤
// ============================================================================
